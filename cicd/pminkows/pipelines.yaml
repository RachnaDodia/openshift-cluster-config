apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  creationTimestamp: null
  name: quay-registry-secret
  namespace: pminkows-cicd
spec:
  encryptedData:
    .dockerconfigjson: AgBxUuwv+80nW+ReBMeNPDiaihzmh9YNwQYoqIoEkcD07bnnJ2JLmRoVGwtFGlrfSezhAIvaJLSLz1oGTesY8lSZgT+yWPzXZp+gsDOk5MIm/MmSyT5+wOw4q/+2/AAbO/XdxYLAFa8XxQ3nUjxzDkfPJEmJbhj64es5KdAiWD6ZXbmbwVQnXmJYjcvSU/9OUzeCjXMiuf8CpHDcpa4h5oAXl2zkBFb2D1Ou/OpzhyXFwkkFXBCI4QXO2JZ0+ZMEuQBublGXQFzfTDUkYlgSGojyuefho2yNnLPsPfZ/Dx4Qo15V9bfHgUQXF82cMzVseTUwfhSsKHiCxoHXQNM5XMyg59yPzylPwEBq5en18LdbSkDYZmJsvSRDNJGu6ENXosUT/gtE4Sd9UiHymxYjHDnxd+N2wjgFM4/opyP7rC0oL4GDyHT7Uumi9rHD8NhBzA+vPmNo3OxMdIz/ArohpUjcGGX9r4xYEHO3JVnnzi4FlCEdVw0GBb7CQlKvSINawuD/3VUKbpVdVen8sFpjiON9/YQM0e1Wz0zMEitALElJbj9XUEZ6fU1e/3i4urKPn+WZxEE5Snf86hY075zbwhJdEoNAdGiKS9ErPqabHZyUazXwpGvmB3zew4kQnwVLTKF0i3aKxWBM6n+yopV/8CKoNXFp4iLSL3mzDeONNR5u5NKlW6rYNvzj8b+sdyYq22fJXy4brwfbjiu9rK4QrR1WMb8V4OkHkDj8xFxB6hBXI6vrr2nxrRayuMlsjpS/PSTGty2phrQwJ9UWfyLOr+IgCW2zpF3F5tRM8xL5S6+5YUCuYgI6TOMa4rCBKLuDZH5Lf7KMaGFRnOTUtIdONWPcEt2XZEZASQ8Us7vAuzA517fMQ5hpzlOcod0djknqEjwzQ4Cdf/z5YWKgKWHK/IEpan1neLwsR4ETV0UCf1+29pN1Uxlp4eUf1AUu
  template:
    data: null
    metadata:
      creationTimestamp: null
      name: quay-registry-secret
      namespace: pminkows-cicd
    type: kubernetes.io/dockerconfigjson
---
apiVersion: redhatcop.redhat.io/v1alpha1
kind: ResourceLocker
metadata:
  name: patch-pipeline-service-account
  namespace: openshift-gitops
spec:
  patches:
    - id: patch1
      patchTemplate: |
        secrets:
          - name: quay-registry-secret
      patchType: application/strategic-merge-patch+json
      sourceObjectRefs:
        - apiVersion: v1
          name: openshift-gitops
          kind: Namespace
        - apiVersion: v1
          name: openshift-gitops-argocd-application-controller
          namespace: openshift-gitops
          kind: ServiceAccount
      targetObjectRef:
        apiVersion: v1
        name: pipeline
        namespace: pminkows-cicd
        kind: ServiceAccount
  serviceAccountRef:
    name: openshift-gitops-argocd-application-controller
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: pipelines-scc-rolebinding
  namespace: pminkows-cicd
subjects:
  - kind: ServiceAccount
    name: pipeline
    namespace: pminkows-cicd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: pipelines-scc-clusterrole
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: dotnet-pipeline-pvc
  namespace: pminkows-cicd
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
  volumeMode: Filesystem
---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: sample-dotnet-pipeline
  namespace: pminkows-cicd
spec:
  params:
    - name: APP_VERSION
      description: Version number of application
      type: string
    - name: DOTNET_VERSION
      description: Version of .NET framework
      type: string
    - name: TESTS_DIR
      description: The name of the directory with unit tests
      type: string
  tasks:
    - name: git-clone
      params:
        - name: url
          value: 'https://github.com/piomin/s2i-dotnetcore-ex.git'
        - name: revision
          value: dotnet-5.0
        - name: submodules
          value: 'true'
        - name: depth
          value: '1'
        - name: sslVerify
          value: 'true'
        - name: deleteExisting
          value: 'true'
        - name: verbose
          value: 'true'
        - name: gitInitImage
          value: >-
            registry.redhat.io/openshift-pipelines/pipelines-git-init-rhel8@sha256:afc5d3f9efe26c7042635d43b8ffd09d67936e3d0b6b901dc08a33e20313d361
      taskRef:
        kind: ClusterTask
        name: git-clone
      workspaces:
        - name: output
          workspace: shared-workspace
    - name: s2i-dotnet
      params:
        - name: BUILDER_IMAGE
          value: >-
            registry.redhat.io/rhel8/buildah@sha256:6a68ece207bc5fd8db2dd5cc2d0b53136236fb5178eb5b71eebe5d07a3c33d13
        - name: VERSION
          value: $(params.DOTNET_VERSION)
        - name: PATH_CONTEXT
          value: .
        - name: TLSVERIFY
          value: 'false'
        - name: IMAGE
          value: >-
            quay.io/pminkows/sample-dotnetcore-ex:$(params.APP_VERSION)
      runAfter:
        - dotnet-test
      taskRef:
        kind: ClusterTask
        name: s2i-dotnet
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: dotnet-test
      params:
        - name: DOTNET_IMAGE
          value: >-
            image-registry.openshift-image-registry.svc:5000/openshift/dotnet:$(params.DOTNET_VERSION)
        - name: TEST_DIR
          value: $(params.TESTS_DIR)
      runAfter:
        - git-clone
      taskRef:
        kind: Task
        name: dotnet-test
      workspaces:
        - name: source
          workspace: shared-workspace
  workspaces:
    - name: shared-workspace
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: maven-settings
  namespace: pminkows-cicd
data:
  settings.xml: >-
    <?xml version="1.0" encoding="UTF-8"?>
    <settings xmlns="http://maven.apache.org/SETTINGS/1.1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.1.0 http://maven.apache.org/xsd/settings-1.1.0.xsd">

    </settings>
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: sonar-properties
  namespace: pminkows-cicd
data:
  sonar-project.properties: |
    sonar.organization=piomin
    sonar.login=f6b415dd54f74a7e3361976820544c2b138791d4
    sonar.qualitygate.wait=true
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: kotlin-pipeline-pvc
  namespace: pminkows-cicd
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
  volumeMode: Filesystem
---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: sample-kotlin-pipeline
  namespace: pminkows-cicd
spec:
  finally:
    - name: s2i-java
      params:
        - name: PATH_CONTEXT
          value: .
        - name: TLSVERIFY
          value: 'false'
        - name: MAVEN_ARGS_APPEND
          value: ''
        - name: MAVEN_CLEAR_REPO
          value: 'false'
        - name: IMAGE
          value: >-
            quay.io/pminkows/sample-kotlin-spring:$(tasks.get-version.results.version)
      taskRef:
        kind: ClusterTask
        name: s2i-java
      workspaces:
        - name: source
          workspace: source-dir
  tasks:
    - name: git-clone
      params:
        - name: url
          value: 'https://github.com/piomin/sample-spring-kotlin-microservice.git'
        - name: revision
          value: s2i
        - name: submodules
          value: 'true'
        - name: depth
          value: '1'
        - name: sslVerify
          value: 'false'
        - name: deleteExisting
          value: 'true'
        - name: verbose
          value: 'true'
      taskRef:
        kind: ClusterTask
        name: git-clone
      workspaces:
        - name: output
          workspace: source-dir
    - name: maven
      params:
        - name: MAVEN_IMAGE
          value: >-
            gcr.io/cloud-builders/mvn@sha256:57523fc43394d6d9d2414ee8d1c85ed7a13460cbb268c3cd16d28cfb3859e641
        - name: GOALS
          value:
            - test
        - name: PROXY_PROTOCOL
          value: http
        - name: CONTEXT_DIR
          value: .
      runAfter:
        - git-clone
      taskRef:
        kind: ClusterTask
        name: maven
      workspaces:
        - name: source
          workspace: source-dir
        - name: maven-settings
          workspace: maven-settings
    - name: sonarqube
      params:
        - name: SONAR_HOST_URL
          value: 'https://sonarcloud.io'
        - name: SONAR_PROJECT_KEY
          value: sample-spring-kotlin
      runAfter:
        - maven
      taskRef:
        kind: Task
        name: sonarqube-scanner
      workspaces:
        - name: source-dir
          workspace: source-dir
        - name: sonar-settings
          workspace: sonar-settings
    - name: get-version
      params:
        - name: MAVEN_IMAGE
          value: >-
            gcr.io/cloud-builders/mvn@sha256:57523fc43394d6d9d2414ee8d1c85ed7a13460cbb268c3cd16d28cfb3859e641
        - name: CONTEXT_DIR
          value: .
      runAfter:
        - sonarqube
      taskRef:
        kind: Task
        name: maven-get-project-version
      workspaces:
        - name: source
          workspace: source-dir
    - name: jira-issue
      params:
        - name: token-secret-name
          value: jira-token-secret
        - name: project-key
          value: PIOM
        - name: username
          value: piotr.minkowski@gmail.com
        - name: url
          value: piotrminkowski.atlassian.net
        - name: title
          value: $(tasks.get-version.results.version)
      runAfter:
        - get-version
      taskRef:
        kind: Task
        name: send-to-jira
  workspaces:
    - name: source-dir
    - name: maven-settings
    - name: sonar-settings
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: dotnet-multiproj-pipeline-pvc
  namespace: pminkows-cicd
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
  volumeMode: Filesystem
---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: sample-dotnet-multiproj-pipeline
  namespace: pminkows-cicd
spec:
  params:
    - name: APP_VERSION
      description: Version number of application
      type: string
    - name: DOTNET_VERSION
      description: Version of .NET framework
      type: string
    - name: TESTS_DIR
      description: The name of the directory with unit tests
      type: string
    - name: APP_PROJECT
      description: The file with project .csproj
      type: string
  tasks:
    - name: git-clone
      params:
        - name: url
          value: 'https://github.com/piomin/web-api-2.git'
        - name: revision
          value: master
        - name: submodules
          value: 'true'
        - name: depth
          value: '1'
        - name: sslVerify
          value: 'true'
        - name: deleteExisting
          value: 'true'
        - name: verbose
          value: 'true'
      taskRef:
        kind: ClusterTask
        name: git-clone
      workspaces:
        - name: output
          workspace: shared-workspace
    - name: s2i-dotnet-multiproj
      params:
        - name: VERSION
          value: $(params.DOTNET_VERSION)
        - name: APP_PROJECT
          value: $(params.APP_PROJECT)
        - name: PATH_CONTEXT
          value: .
        - name: TLSVERIFY
          value: 'false'
        - name: IMAGE
          value: quay.io/pminkows/web-api-2:$(params.APP_VERSION)
      runAfter:
        - dotnet-test
      taskRef:
        kind: ClusterTask
        name: s2i-dotnet-multiproj
      workspaces:
        - name: source
          workspace: shared-workspace
    - name: dotnet-test
      params:
        - name: DOTNET_IMAGE
          value: >-
            image-registry.openshift-image-registry.svc:5000/openshift/dotnet:$(params.DOTNET_VERSION)
        - name: TEST_DIR
          value: $(params.TESTS_DIR)
      runAfter:
        - git-clone
      taskRef:
        kind: Task
        name: dotnet-test
      workspaces:
        - name: source
          workspace: shared-workspace
  workspaces:
    - name: shared-workspace
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  creationTimestamp: null
  name: jira-token-secret
  namespace: pminkows-cicd
spec:
  encryptedData:
    token: AgCO2iHutV77xKUMOS+dKV1MxtKIU6FWn9scaLdZySM/3Gm3+gORVDEe3obCIOX+Iob5K20wLPdn9rT6SD6SqPzZXWSN1GoKLmNJL+btBTj5nVsbgAsXzlbgxlqC30y3G/qFh9uxrftKG8R6EztGir3m79VAf44geLAR//9dDwxmknob9aSkHLr2WBgw5+T60kWw8UKnevIpH3WuNYWoe8rfjhiGR7CHGDXu3nLUOOu28Szb9rj1G+Jdi1zP7L+8HnDviMmA9kVpz/DyQDnkMUW5EB3q71RpkUYjFAFNDtkC6auo1Akj8+qHTAsMzBAnexnGr34JhbVfu+qgjqU3wThYBVWpqAn0zl/wJRZ1MhpZ67QCuG0OUwacMu0eLZObNNn4Ui3AHmEF5G07Y1sKLdS7r3A0eeuqN5pVj2+aXFqBYizMfE7GQBW99/5Gs3QQerCIEOSPeJajkyYnW7YnHjeO0C6XRtYfvbWQdeiWow7JZZiu4zz8LY9ergvcQWZS/fTTCz7AIRoYqxYZRX9JAZZRLzJF6yq9hljf2u5m93TwAzJfEGTtokahHYMcYWHeSKtMQsh3yQ+53ACoCmFc4F3uT0K89oaQnaenfeuFxk0iA+Au/eFawakLeDNHcxKcleH2geSJptpIUdLbl7tNgnAzABo7N5mPlAdC9k89DMsUCEGUYrhVB6bbPHXQQGVkY4BtOiddPwCvPRLkYiXaiWLKsJE7XO2qAqI=
  template:
    data: null
    metadata:
      creationTimestamp: null
      name: jira-token-secret
      namespace: pminkows-cicd
    type: Opaque